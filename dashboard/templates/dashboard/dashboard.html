{% extends 'base.html' %}


{% block content %}

<style type="text/css">
.table-custom {
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 10px;
        }

        .table-custom th {
            background: #2babf0;
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .table-custom td, 
        .table-custom th {
            padding: 0.3rem;
            text-align: center;
            vertical-align: middle;
        }

        .table-custom tr:nth-child(even) {
            background-color: #f8f9fa;
        }

</style>

{% include 'dashboard/jfl_alert_modal.html' %}
<div class="container pt-2">	
	<div class="text-success rounded h4 p-1 d-flex justify-content-between align-items-center">
		<span class="text-left">
			   Dashboard of {{ request.user.designation }}
			</span>
			    <span class="text-right">
			        Your Pending 
			     <span class="badge bg-danger rounded-pill text-white">
			      {{ pending_qty }}
			</span>
		</span>
	</div>

<!---MT Dashboard--->
{% if role == 'MT' %}
    <h1>Welcome, MT</h1>
    <p>You have to create Test Data</p>

<!---MTS Dashboard--->
{% elif role == 'MTS' %}
            {% if posts %}
			<div class="table-responsive-md">
			    <table class="table table-hover table-striped table-sm table-custom" id="pending_table">
			        <thead>
			            <tr>
			                <th scope="col" class="py-2">ID</th>
			                <th scope="col" class="py-2">Meter No</th>
			                <th scope="col" class="py-2">Reading</th>
			                <th scope="col" class="py-2">Account</th>
			                <th scope="col" class="py-2">Result</th>
			                <th scope="col" class="py-2">Date</th>
			                {% if role == 'BS' %}
			                    <th scope="col" class="py-2">Print</th>
			                {% endif %}
			                <th scope="col" class="py-2">Action</th>
			            </tr>
			        </thead>
			        <tbody class="post_list text-nowrap">
			            {% for item in posts %}
			                {% include 'dashboard/'|add:role|add:'_dashboard_item.html' %}
			            {% endfor %}
			        </tbody>
			    </table>
			</div>
			{% else %}
                <div class="form-control text-center text-danger">No pending items!</div>
            {% endif %}


<!---AGM DGM Dashboard--->
{% elif role == 'AGM' or role == 'DGM' %}
            {% if posts %}
			<div class="table-responsive-md">
			    <table class="table table-hover table-striped table-sm table-custom" id="pending_table">
			        <thead>
			            <tr>
			                <th scope="col" class="py-2">ID</th>
			                <th scope="col" class="py-2">Meter No</th>
			                <th scope="col" class="py-2">Reading</th>
			                <th scope="col" class="py-2">Account</th>
			                <th scope="col" class="py-2">Result</th>
			                <th scope="col" class="py-2">Date</th>
			                {% if role == 'BS' %}
			                    <th scope="col" class="py-2">Print</th>
			                {% endif %}
			                <th scope="col" class="py-2">Action</th>
			            </tr>
			        </thead>
			        <tbody class="post_list text-nowrap">
			            {% for item in posts %}
			                {% include 'dashboard/'|add:role|add:'_dashboard_item.html' %}
			            {% endfor %}
			        </tbody>
			    </table>
			</div>
			{% else %}
                <div class="form-control text-center text-danger">No pending items!</div>
            {% endif %}



<!---BS BA Dashboard--->
{% elif role == 'BS' or role == 'BA' %}
            {% if posts %}
			<div class="table-responsive-md">
			    <table class="table table-hover table-striped table-sm table-custom" id="pending_table">
			        <thead>
			            <tr>
			                <th scope="col" class="py-2">ID</th>
			                <th scope="col" class="py-2">Meter No</th>
			                <th scope="col" class="py-2">Reading</th>
			                <th scope="col" class="py-2">Account</th>
			                <th scope="col" class="py-2">Result</th>
			                <th scope="col" class="py-2">Date</th>
			                {% if role == 'BS' %}
			                    <th scope="col" class="py-2">Print</th>
			                {% endif %}
			                <th scope="col" class="py-2">Action</th>
			            </tr>
			        </thead>
			        <tbody class="post_list text-nowrap">
			            {% for item in posts %}
			                {% include 'dashboard/'|add:role|add:'_dashboard_item.html' %}
			            {% endfor %}
			        </tbody>
			    </table>
			</div>
			{% else %}
                <div class="form-control text-center text-danger">No pending items!</div>
            {% endif %}

<!---JE LT LM Dashboard--->
{% elif role == 'JE' or role== 'LT' or role == 'LM' %}
            {% if posts %}
			<div class="table-responsive-md">
			    <table class="table table-hover table-striped table-sm table-custom" id="pending_table">
			        <thead>
			            <tr>
			                <th scope="col" class="py-2">ID</th>
			                <th scope="col" class="py-2">Meter No</th>
			                <th scope="col" class="py-2">Reading</th>
			                <th scope="col" class="py-2">Account</th>
			                <th scope="col" class="py-2">Result</th>
			                <th scope="col" class="py-2">Date</th>
			                {% if role == 'BS' %}
			                    <th scope="col" class="py-2">Print</th>
			                {% endif %}
			                <th scope="col" class="py-2">Action</th>
			            </tr>
			        </thead>
			        <tbody class="post_list text-nowrap">
			            {% for item in posts %}
			                {% include 'dashboard/'|add:role|add:'_dashboard_item.html' %}
			            {% endfor %}
			        </tbody>
			    </table>
			</div>
			{% else %}
                <div class="form-control text-center text-danger">No pending items!</div>
            {% endif %}


<!---IT Dashboard--->
{% elif role == 'IT' %}
{% if profile %}
	<div class="table-responsive">
		<table class="table  table-hover table-striped table-sm" id="panding_table">
		  <thead>
		    <tr>
		      <th scope="col" class="py-2">ID</th>
		      <th scope="col" class="py-2">User ID</th>
		      <th scope="col" class="py-2">Name</th>
		      <th scope="col" class="py-2">Designation</th>
			    <th scope="col" class="py-2">Roll</th>
		      <th scope="col" class="py-2">Office</th>
		      <th scope="col" class="py-2">Action</th>
		    </tr>
		  </thead>
		  <tbody class="post_list text-nowrap">
		        {% for item in profile %}
		        {% include 'dashboard/admin_dashboard_item.html' %}
		        {% endfor %}
		  </tbody>
		</table>
		</div>
		     {% else %}
		        <div class="form-control text-center text-danger">কোন পেন্ডিং নাই!</div>
		     {% endif %}
	</div>


<!---Admin Dashboard--->
{% elif role == 'Admin' %}
{% if profile %}
	<div class="table-responsive">
	<table class="table  table-hover table-striped table-sm" id="panding_table">
	  <thead>
	    <tr>
	      <th scope="col" class="py-2">ID</th>
	      <th scope="col" class="py-2">User ID</th>
	      <th scope="col" class="py-2">Name</th>
	      <th scope="col" class="py-2">Designation</th>
		    <th scope="col" class="py-2">Roll</th>
	      <th scope="col" class="py-2">Office</th>
	      <th scope="col" class="py-2">Action</th>
	    </tr>
	  </thead>
	  <tbody class="post_list text-nowrap">
	        {% for item in profile %}
	        {% include 'dashboard/admin_dashboard_item.html' %}
	        {% endfor %}
	  </tbody>
	</table>
	</div>
	     {% else %}
	        <div class="form-control text-center text-danger">কোন পেন্ডিং নাই!</div>
	     {% endif %}
	</div>


<!---User Dashboard--->
{% elif role == 'User' %}
    <h1>Welcome, User</h1>
    <p>You have no selected for any Office or designations</p>

<!---Others Dashboard--->    
{% else %}
    <h1>Welcome!</h1>
    <p>Your role is not recognized.</p>
{% endif %}

       



   <p class="text-center text-secondary" id="loading_post" style="display:none;">Loading...</p>
 </div>


<script type="text/javascript">
            $(document).ready(function () {
                window.post_url = '{% url role|lower|add:"_dashboard" %}';
                var page = 1;
                var block_request = false;
                var end_pagination = false;

                $(window).scroll(function () {
                    var margin = $(document).height() - $(window).height() - 200;
                    if ($(window).scrollTop() > margin && !end_pagination && !block_request) {
                        $('#loading_post').show();
                        block_request = true;
                        page += 1;

                        $.ajax({
                            type: 'GET',
                            url: window.post_url,
                            data: { "page": page },
                            success: function (data) {
                                if (data.end_pagination) {
                                    end_pagination = true;
                                } else {
                                    block_request = false;
                                }
                                $('.post_list').append(data.content);
                                $('#loading_post').hide();
                            }
                        });
                    }
                });
            });

            $(document).on('click', '#sing_submit', function() {
                var test_id = $(this).closest('div').find('input').val();
                var csrftoken = $("[name=csrfmiddlewaretoken]").val();
                var pending_qty = $('#panding_qty').text();

                if (test_id === '') {
                    jfl_delete_alert('Please reload the page.');
                } else {
                    $.ajax({
                        url: window.post_url,
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            test_id: test_id,
                            csrfmiddlewaretoken: csrftoken
                        },
                        success: function (data) {
                            $('#panding_table tbody').empty();

                            for (var i = 0; i < data.length; i++) {
                                $('#panding_table tbody').append(
                                    `<tr>
                                        <td class="pt-3">${data[i].id}</td>
                                        <td class="pt-3">${data[i].tested_meter_no}</td>
                                        <td class="pt-3">${data[i].reading_as_found}</td>
                                        <td class="pt-3">${data[i].book} - ${data[i].account}</td>
                                        <td class="pt-3">${data[i].comments}</td>
                                        <td class="pt-3">${data[i].date}</td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <input name="test_id" class="test_id" value="${data[i].id}" hidden>
                                                <button type="button" class="btn btn-info btn-sm">
                                                    <a href="#" class="text-decoration-none">View</a>
                                                </button>
                                                <button type="submit" id="sing_submit" class="btn btn-success btn-sm">Sign</button>
                                            </div>
                                        </td>
                                    </tr>`
                                );
                            }

                            var x = pending_qty - 1;
                            $('#panding_qty').text(x);
                            jfl_delete_alert('Completed successfully.');
                        },
                        error: function () {
                            jfl_delete_alert('Connection error! Server not connected.');
                        }
                    });
                }
            });
        </script>


<script type="text/javascript">
  //for auto scholl pagew loading.
$(document).ready(function () {
    window.post_url = '{% url 'admin_dashboard' %}';
    var page = 1;
    var block_request = false;
    var end_pagination = false;
    
    $(window).scroll(function () {
      var margin = $(document).height() - $(window).height() - 200;
      if ($(window).scrollTop() > margin && end_pagination === false && block_request === false){
            $('#loading_post').show();
            block_request = true;
            page += 1;

            $.ajax({
                    type: 'GET',
                    url: window.post_url,
                    data: {"page": page},
                    success: function (data) {
                            if (data.end_pagination === true) {
                                end_pagination = true;
                            } else {
                                block_request = false;
                            }
                            $('.post_list').append(data.content);
                            $('#loading_post').hide();
                        }
                    })
                }
            });
        })




//for admin and it
$(document).on('click', '#sing_submit', function(){
    var test_id =$(this).closest('div').find('input').val();
    console.log(test_id)
    var csrftoken=$("[name=csrfmiddlewaretoken]").val();
    if(test_id==''){
        jfl_delete_alert('রিলোড করুন।');
    }else{
        $.ajax({
            url: '/admin_dashboard',
            type: 'POST',
            dataType: 'json',
            data:{
                  test_id : test_id,
                  csrfmiddlewaretoken : csrftoken
            },
        })
        .done(function(data){

        $('#panding_table tbody').empty();

        for(i=0;i<data.length;i++){
            $('#panding_table tbody').append(
              '<tr>'+
                  '<td class="pt-3">'+data[i].id+'</td>'+
                  '<td class="pt-3">'+data[i].tested_meter_no+'</td>'+
                    '<td class="pt-3">'+data[i].reading_as_found+'</td>'+
                    '<td class="pt-3">'+data[i].book+' - '+data[i].account+' </td>'+
                    '<td class="pt-3">'+data[i].comments+'</td>'+
                    '<td class="pt-3">'+data[i].date+'</td>'+

                    '<td>'+ '{% csrf_token %}' +
                      '<div class="btn-group" role="group" aria-label="Basic example">'+
                        '<input name="test_id" class="test_id" id="test_id" value="'+data[i].id+'" hidden>'+
                        '<button type="button" class="btn btn-info btn-sm"> <a href="#" class="text-decoration-none">View</a></button>'+
                        '<button type="submit" id="sing_submit" class="btn btn-success btn-sm">Sign</button>'+
                       '</div>'+
                    '</td>'+

                 '</tr>'
                ); //appending in the tablereading_as_found




        };//endfor;

            jfl_delete_alert('সফলভাবে সম্পন্ন হয়েছে।');
            //location.reload(); reload the page
            
        })
        .fail(function(){
            jfl_delete_alert('সমস্যা আছে! সার্ভার সংযুক্ত নয়!')
        })
    }
})

</script>


{% endblock %}



